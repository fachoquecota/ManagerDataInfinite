@model List<ProductoModel>
@{
    int paginaActual = ViewBag.PaginaActual;
    int totalPaginas = (int)Math.Round((double)ViewBag.TotalPaginas);
}

<!-- Búsqueda -->
<div class="mb-4 flex">
    <form method="get" class="flex-auto">
        <input type="text" name="busqueda" placeholder="Buscar productos" class="p-2 border rounded" />
        <button type="submit" class="p-2 bg-blue-500 text-white rounded">Buscar</button>
    </form>
</div>

<!-- Tabla -->
<div class="overflow-x-auto">
    <table class="min-w-full bg-white border border-gray-300">
        <thead>
            <tr class="bg-gray-100 text-left">
                <th class="py-2 px-4 border-b">ID</th>
                <th class="py-2 px-4 border-b">Producto</th>
                <th class="py-2 px-4 border-b">Marca</th>
                <th class="py-2 px-4 border-b">Precio</th>
                <th class="py-2 px-4 border-b">Cantidad</th>
                <th class="py-2 px-4 border-b">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var producto in Model)
            {
                <tr>
                    <td class="py-2 px-4 border-b">@producto.IdProducto</td>
                    <td class="py-2 px-4 border-b">@producto.Producto</td>
                    <td class="py-2 px-4 border-b">@producto.Marca</td>
                    <td class="py-2 px-4 border-b">@producto.Precio</td>
                    <td class="py-2 px-4 border-b">@producto.Cantidad</td>
                    <td class="py-2 px-4 border-b">
                        <button data-id="@producto.IdProducto" class="open-modal text-blue-500 hover:underline">Editar</button> |
                        <a href="@Url.Action("Eliminar", "Productos", new { id = producto.IdProducto })" class="text-red-500 hover:underline">Eliminar</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
<!-- Modal -->
<div id="editModal" class="fixed inset-0 flex items-center justify-center p-4 hidden">
    <div class="bg-black opacity-50 absolute inset-0"></div>
    <div class="bg-white p-8 rounded-lg w-3/4 relative z-10">
        <h2 class="text-2xl mb-4">Editar Producto: <span id="modalTitleId"></span></h2>
        <div id="modalContent">
            <form id="editForm" class="flex flex-wrap -mx-2">
                <!-- Columna 1 -->
                <div class="w-1/2 px-2 mb-4">
                    <label for="producto" class="block text-sm font-medium text-gray-600">Producto</label>
                    <input type="text" id="producto" name="producto" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <div class="w-1/2 px-2 mb-4">
                    <label for="marca" class="block text-sm font-medium text-gray-600">Marca</label>
                    <input type="text" id="marca" name="marca" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <div class="w-1/2 px-2 mb-4">
                    <label for="precio" class="block text-sm font-medium text-gray-600">Precio</label>
                    <input type="number" id="precio" name="precio" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <div class="w-1/2 px-2 mb-4">
                    <label for="cantidad" class="block text-sm font-medium text-gray-600">Cantidad</label>
                    <input type="number" id="cantidad" name="cantidad" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <div class="w-1/2 px-2 mb-4">
                    <label for="idProveedor" class="block text-sm font-medium text-gray-600">ID Proveedor</label>
                    <select id="idProveedor" name="idProveedor" class="mt-1 p-2 w-full border rounded-md"></select>
                </div>
                <div class="w-1/2 px-2 mb-4">
                    <label for="fechaIngreso" class="block text-sm font-medium text-gray-600">Fecha de Ingreso</label>
                    <input type="date" id="fechaIngreso" name="fechaIngreso" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <!-- Columna 2 -->
                <div class="w-1/2 px-2 mb-4">
                    <label for="imagenCarpeta" class="block text-sm font-medium text-gray-600">Carpeta de Imagen</label>
                    <input type="text" id="imagenCarpeta" name="imagenCarpeta" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <div class="w-1/2 px-2 mb-4">
                    <label for="imagenNombre" class="block text-sm font-medium text-gray-600">Nombre de Imagen</label>
                    <input type="text" id="imagenNombre" name="imagenNombre" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <div class="w-1/2 px-2 mb-4">
                    <label for="horaCreacion" class="block text-sm font-medium text-gray-600">Hora de Creación</label>
                    <input type="datetime-local" id="horaCreacion" name="horaCreacion" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <div class="w-1/2 px-2 mb-4">
                    <label for="horaActualizacion" class="block text-sm font-medium text-gray-600">Hora de Actualización</label>
                    <input type="datetime-local" id="horaActualizacion" name="horaActualizacion" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <div class="w-1/2 px-2 mb-4">
                    <label for="activo" class="block text-sm font-medium text-gray-600">Activo</label>
                    <input type="checkbox" id="activo" name="activo" class="mt-1">
                </div>
                <div class="w-1/2 px-2 mb-4">
                    <label for="idGenero" class="block text-sm font-medium text-gray-600">ID Género</label>
                    <select id="idGenero" name="idGenero" class="mt-1 p-2 w-full border rounded-md"></select>
                </div>
                <div class="w-1/2 px-2 mb-4">
                    <label for="idCategoria" class="block text-sm font-medium text-gray-600">ID Categoría</label>
                    <select id="idCategoria" name="idCategoria" class="mt-1 p-2 w-full border rounded-md"></select>
                </div>
            </form>
        </div>
        <div class="flex justify-end mt-4">
            <button id="saveChanges" class="bg-blue-500 text-white p-2 rounded mr-2">Guardar Cambios</button>
            <button id="closeModal" class="bg-red-500 text-white p-2 rounded">Cerrar</button>
        </div>
    </div>
</div>





<!-- Paginación -->
<div class="mt-4">
    @for (int i = 1; i <= totalPaginas; i++)
    {
        <a href="@Url.Action("Index", "Productos", new { pagina = i })" class="@(i == paginaActual ? "bg-blue-500 text-white" : "text-blue-500") px-3 py-2 rounded-full mx-1">@i</a>
    }
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Escuchar clics en los botones "Editar"
        document.querySelectorAll('.open-modal').forEach(button => {
            button.addEventListener('click', async function(e) {
                const id = e.target.getAttribute('data-id');
                
                // Hacer una llamada AJAX para obtener los datos del producto
                const response = await fetch(`/Productos/GetProductoById?idProducto=${id}`);
                if (response.ok) {
                    const data = await response.json();
                    const producto = data.result[0];
                        // Aquí es donde colocarías la línea para actualizar el título del modal
                    document.getElementById('modalTitleId').innerText = producto.idProducto;

                    // Llenar los campos del formulario en el modal
                    //document.getElementById('idProducto').value = producto.idProducto;
                    document.getElementById('producto').value = producto.producto;
                    document.getElementById('marca').value = producto.marca;
                    document.getElementById('precio').value = producto.precio;
                    document.getElementById('cantidad').value = producto.cantidad;
                    document.getElementById('fechaIngreso').value = producto.fechaIngreso;
                    //document.getElementById('idEmpresa').value = producto.idEmpresa;
                    document.getElementById('imagenCarpeta').value = producto.imagenCarpeta;
                    document.getElementById('imagenNombre').value = producto.imagenNombre;
                    document.getElementById('horaCreacion').value = producto.horaCreacion;
                    document.getElementById('horaActualizacion').value = producto.horaActualizacion;
                    document.getElementById('activo').checked = producto.activo;
                    
                    // Obtener y llenar el combobox de proveedores
                    await fillComboBox('idProveedor', '/Productos/GetProveedores', producto.idProveedor);
                    
                    // Obtener y llenar el combobox de géneros
                    await fillComboBox('idGenero', '/Productos/GetGeneros', producto.idGenero);

                    // Obtener y llenar el combobox de categorías
                    await fillComboBox('idCategoria', '/Productos/GetCategorias', producto.idCategoria);

                    // Mostrar el modal
                    document.getElementById('editModal').classList.remove('hidden');


                }
            });
        });

        // Función para llenar un combobox
        async function fillComboBox(selectId, apiUrl, selectedValue) {
            const response = await fetch(apiUrl);
            if (response.ok) {
                const data = await response.json();
                const items = data.result;

                const select = document.getElementById(selectId);
                select.innerHTML = '';
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id || item.idProveedor;  // Asume que el campo se llama 'id' o 'idProveedor'
                    option.text = item.descripcion || item.proveedor;  // Asume que el campo se llama 'descripcion' o 'proveedor'
                    select.appendChild(option);
                });

                // Seleccionar el valor correcto en el combobox
                select.value = selectedValue;
            }
        }

        // Cerrar el modal
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('editModal').classList.add('hidden');
        });

        // Guardar cambios (aquí podrías enviar los datos al servidor)
        document.getElementById('saveChanges').addEventListener('click', function() {
            // Lógica para guardar cambios
            document.getElementById('editModal').classList.add('hidden');
        });
    });
</script>

